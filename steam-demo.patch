From 32ea743ba938b0080c8bd12f7ae3b55516521ed3 Mon Sep 17 00:00:00 2001
From: invalid <60469730+scrungofan@users.noreply.github.com>
Date: Fri, 11 Nov 2022 20:50:23 +0200
Subject: [PATCH] Steam demo support

---
 components/index.ts                |  9 ++++++++-
 components/oauthToken.ts           | 12 ++++++++++--
 components/platformEntitlements.ts |  1 +
 3 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/components/index.ts b/components/index.ts
index 00c3d71..b62e2b0 100644
--- a/components/index.ts
+++ b/components/index.ts
@@ -55,6 +55,7 @@ import {
     STEAM_NAMESPACE_2016,
     STEAM_NAMESPACE_2018,
     STEAM_NAMESPACE_2021,
+    STEAM_NAMESPACE_2021_DEMO,
     STEAM_NAMESPACE_SCPC,
 } from "./platformEntitlements"
 import { legacyProfileRouter } from "./2016/legacyProfileRouter"
@@ -165,7 +166,10 @@ app.get(
                 "pc-prod_6"
         }
 
-        if (req.query.issuer === STEAM_NAMESPACE_2021) {
+        if (
+            req.query.issuer === STEAM_NAMESPACE_2021 ||
+            req.query.issuer === STEAM_NAMESPACE_2021_DEMO
+        ) {
             config.Versions[0].SERVER_VER.GlobalAuthentication.RequestedAudience =
                 "steam-prod_8"
         }
@@ -323,6 +327,9 @@ app.use(
                 case STEAM_NAMESPACE_2021:
                     req.serverVersion = "8-10"
                     break
+                case STEAM_NAMESPACE_2021_DEMO:
+                    req.serverVersion = "8-10"
+                    break
                 default:
                     res.status(400).json({ message: "no game data" })
                     return
diff --git a/components/oauthToken.ts b/components/oauthToken.ts
index 1fe9b52..93f0f5d 100644
--- a/components/oauthToken.ts
+++ b/components/oauthToken.ts
@@ -25,6 +25,7 @@ import { log, LogLevel } from "./loggingInterop"
 import {
     STEAM_NAMESPACE_2018,
     STEAM_NAMESPACE_2021,
+    STEAM_NAMESPACE_2021_DEMO,
 } from "./platformEntitlements"
 import {
     getExternalUserData,
@@ -147,7 +148,8 @@ export async function handleOauthToken(
 
     const isHitman3 =
         external_appid === "fghi4567xQOCheZIin0pazB47qGUvZw4" ||
-        external_appid === STEAM_NAMESPACE_2021
+        external_appid === STEAM_NAMESPACE_2021 ||
+        external_appid === STEAM_NAMESPACE_2021_DEMO
 
     const gameVersion: GameVersion = isFrankenstein
         ? "scpc"
@@ -255,7 +257,13 @@ export async function handleOauthToken(
                         req.body.access_token,
                         req.body.epic_userid,
                     )
-                } else if (external_platform === "steam") {
+                } else if (external_appid === STEAM_NAMESPACE_2021) {
+                    return await new IOIStrategy(
+                        gameVersion,
+                        STEAM_NAMESPACE_2021,
+                    ).get(req.body.pId)
+                } else if (external_appid === STEAM_NAMESPACE_2021_DEMO) {
+                    log(LogLevel.INFO, `Sus`)
                     return await new IOIStrategy(
                         gameVersion,
                         STEAM_NAMESPACE_2021,
diff --git a/components/platformEntitlements.ts b/components/platformEntitlements.ts
index 54fe15e..ae636c1 100644
--- a/components/platformEntitlements.ts
+++ b/components/platformEntitlements.ts
@@ -121,6 +121,7 @@ export const STEAM_NAMESPACE_SCPC = "783781"
 export const STEAM_NAMESPACE_2018 = "863550"
 export const EPIC_NAMESPACE_2021 = "ed55aa5edc5941de92fd7f64de415793"
 export const STEAM_NAMESPACE_2021 = "1659040"
+export const STEAM_NAMESPACE_2021_DEMO = "1847520"
 
 export const FRANKENSTEIN_SNIPER_ENTITLEMENTS = [STEAM_NAMESPACE_2016, "783781"]
 
